FROM python:3.11

WORKDIR /

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    wget \
    zip \
    tree \
    unzip && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN node --version && npm --version

# Create React app with Vite
RUN npm create vite@latest frontend -- --template react

COPY images/sample-package-react-shadcn-vite.json /frontend/package.json

# Set working directory and install dependencies
WORKDIR /frontend
RUN npm install

# Install additional dependencies
RUN npm install lucide-react axios recharts @radix-ui/react-icons tailwind-merge react-hook-form
RUN npm install -D eslint eslint-plugin-react

# Install and set up Tailwind CSS manually
RUN npm install -D tailwindcss postcss autoprefixer

# Create Tailwind config files with .cjs extension for CommonJS syntax
RUN echo 'module.exports = {\n\
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],\n\
  theme: {\n\
    extend: {},\n\
  },\n\
  plugins: [],\n\
};' > tailwind.config.cjs

RUN echo 'module.exports = {\n\
  plugins: {\n\
    tailwindcss: {},\n\
    autoprefixer: {},\n\
  }\n\
}' > postcss.config.cjs

# Add CSS imports for tailwind
RUN echo '@tailwind base;\n\
@tailwind components;\n\
@tailwind utilities;' > ./src/index.css

# Fetch and add Shadcn UI components directly into src/components/ui
RUN mkdir -p /frontend/src/components/ui && \
    cd /frontend/src/components/ui && \
    for component in accordion alert alert-dialog aspect-ratio avatar badge button card checkbox collapsible dialog dropdown-menu hover-card input label popover progress radio-group scroll-area select separator sheet skeleton slider switch table tabs textarea toast toggle tooltip; do \
        curl -s -o "$component.jsx" "https://raw.githubusercontent.com/shadcn-ui/ui/main/components/ui/$component.tsx" && \
        sed -i 's/: string//g' "$component.jsx" && \
        sed -i 's/: boolean//g' "$component.jsx" && \
        sed -i 's/: number//g' "$component.jsx" && \
        sed -i 's/: ReactNode//g' "$component.jsx" && \
        sed -i 's/export type /export /g' "$component.jsx" && \
        sed -i 's/import type /import /g' "$component.jsx"; \
    done

# Update Vite config using ES module syntax
RUN echo 'import { defineConfig } from "vite";\n\
import react from "@vitejs/plugin-react";\n\
\n\
export default defineConfig({\n\
  plugins: [react()],\n\
  server: {\n\
    allowedHosts: true,\n\
    port: 3000,\n\
    host: "0.0.0.0"\n\
  }\n\
});' > vite.config.js

EXPOSE 3000
